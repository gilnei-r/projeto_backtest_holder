# Data Model: Data Provider and Reporting Enhancements

**Version**: 1.0
**Date**: 2025-10-30

This document outlines the data structures involved in the new data provider integration and the reporting enhancements.

## 1. Configuration (`config.py`)

New variables will be added to the `config.py` file to control the data source.

| Variable | Type | Description |
|---|---|---|
| `DATA_SOURCE` | `str` | The selected data provider. Must be one of `yahoofinance`, `metatrader5`, or `metastock`. |
| `METASTOCK_PATH` | `str` | The absolute file path to the directory containing the Metastock `.csv` files. Only used when `DATA_SOURCE` is `metastock`. |

## 2. In-Memory DataFrames

### 2.1. Historical Data (`master_df`)

The structure of the main `master_df` DataFrame containing historical prices will remain unchanged. However, its source will now be determined by the `DATA_SOURCE` configuration.

- **Metastock CSV Reader Output**: The new Metastock reader function will produce a DataFrame with a `DatetimeIndex` and an `Adj Close` column for each ticker. This structure is identical to the output of the existing `yfinance` loader.

### 2.2. Monthly Contribution Scenario Output (`df_valores` and `df_aportes`)

To support the enhanced reporting, the DataFrames generated by the monthly contribution scenarios will be modified.

- `df_valores` (Portfolio Value): This DataFrame tracks the monetary value of each asset over time. No structural changes are required.
- `df_aportes` (Contributions): This DataFrame tracks the contributions made to each asset. A cumulative sum of this DataFrame will be calculated to get the "Total Contribution" for each asset.

### 2.3. Final Distribution DataFrame

A new DataFrame will be constructed for the `distribuicao_valor` plot, combining the final values and total contributions.

**Structure**:

| Ticker | Tipo | Valor |
|---|---|---|
| PETR4 | Valor Atual | 15000.00 |
| PETR4 | Aporte Total | 12000.00 |
| VALE3 | Valor Atual | 18000.00 |
| VALE3 | Aporte Total | 15000.00 |
| CDB | Valor Atual | 10500.00 |
| CDB | Aporte Total | 10000.00 |

This structure is suitable for creating side-by-side bar charts using libraries like `seaborn` or `matplotlib`.

## 3. Excel Report Files

The final summary sheets within `backtest_results_monthly.xlsx` and `backtest_results_cdb_mixed.xlsx` will be augmented with new columns.

**New Columns**:

- `Aporte Total [Ticker]`: A new column for each ticker showing the total cumulative investment in that ticker.
- `Aporte Total CDB`: A new column showing the total cumulative investment in the CDB asset.
